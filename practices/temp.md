# Multi Container

## 파드와 컨테이너의 통신
- 파드는 하나 이상의 컨테이너가 공유하는 네트워크 및 파일 시스템을 제공하는 가상 환경이다. 각각의 컨테이너는 별도의 환경 변수와 자신만의 프로세스를 가지며, 서로 다른 기술 스택으로 구성된 별개의 이미지를 사용할 수 있는 독립된 단위다. 반면 파드는 한 노드상에서 동작하는 하나의 단위다. 따라서 파드에 속한 컨테이너는 모두 같은 노드에서 동작한다.

### 파드안 컨테이너간의 데이터 공유 (Volume)
- 같은 파드 안에 있는 컨테이너는 네트워크를 공유한다. 따라서 모든 컨테이너가 같은 IP 주소(파드의 IP 주소)를 갖는다. 파드 속 컨테이너는 외부 트래픽을 받을 수 있지만 각기 다른 포트를 주시해야 한다. 그리고 같은 파드 속 컨테이너 간 통신에는 localhost 주소를 사용한다.
- 컨테이너는 자신만의 파일 시스템을 갖니만 파드에서 제공하는 볼륨을 마운트할 수 있으며, 이 볼륨을 공유하는 방식으로 컨테이너끼리 정보를 교환할 수 있다.

~~~yaml
# 한 파드안에 두개의 컨테이너를 띄우는 디플로이먼트 정의

spec:
  containers:

    - name: sleep
      image: container-image1
      volumeMounts:
        - name: data
          mountPath: /data-rw

    - name: file-reader
      image: container-image1
      volumeMounts:
        - name: data
          mountPath: /data-ro
          readOnly: true

  volumes:
    # 파드에 생성 공유된 볼륨을 통해 두 컨테이너 간의 데이터 공유가 가능해진다.
    # 볼륨 마운트시 데이터 접근 권한을 통해 파일의 읽기, 쓰기 등의 제한을 걸수 있다.
    - name: data
      emptyDir: {}
~~~


### 파드안 컨테이너간의 네트워크 공유
- 네트워크는 컨테이너마다 각기 다른 포트를 나누어 쓰는 형태로 공유된다. 이런 기능은 애플리케이션이 백그라운드로 돌아가며 진행 사항을 외부에 알리는 기능이 없는 상황에 유용하다. 파드 속 다른 컨테이너가 REST API를 통해 애플리케이션 컨테이너의 상태를 보고하는 형태가 된다.

~~~yaml
# 한 파드 안에 네트워크를 통한 통신

spec:
  containers:
    - name: app-1
      image: container-image

    - name: app-2
      image: container-image
      ports:
        - containerPort: 8080

# app-1 컨테이너에서 wget 명령어를 통한 동일 네트워크의 8080 포트를 사용하는 app-2 컨테이너로 네트워크 통신 테스트
# kubectl exec deploy/[deploy-name] -c app-1 -- wget -q -0 -- localhost:8080
~~~

- 파드는 클러스터상의 IP 주소를 갖고 있다. 파드 속 컨테이너가 어떤 포트를 주시하고 있다면, 다른 파드가 이 포트로 접근할 수 있다. 트래픽을 파드의 특정 포트로 전달하는 서비스를 만들면 이 포트를 주시하는 컨테이너가 요청을 전달 받는다.
	- `kubectl expose -f template.yaml --type=LoadBalancer --port=8020 --target-port=8080`


- 파드는 애플리케이션을 구성하는 한 단위다. 파드는 애플리케이션의 단일 컴포넌트에 대응해야 한다. 애플리케이션 컨테이너를 지원하는 컨테이너를 파드에 추가할 수는 있지만, 한 파드 안에 서로 다른 애플리케이션을 함께 넣어서는 안된다. 이런 구성을 취하면 각각의 컴포넌트를 독립적으로 업데이트 또는 스케일링하거나 관리할 수 없게 된다.













